
function Get-SysmonCQDetails( 
    [string]$path = "c:\windows\system32\cmd.exe",
    [array]$CommandLineArguments){
    
    Write-Host "Testing $path $CommandLineArguments"
        
    $filter = "*[EventData[Data[@Name = 'Image'] = '$path' ]]"
    if($CommandLineArguments.Count -eq 0){
        return Get-WinEvent -MaxEvents 10 -LogName "Microsoft-Windows-Sysmon/Operational" -FilterXPath $filter -ErrorAction SilentlyContinue
    }
    $events = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -FilterXPath $filter -ErrorAction SilentlyContinue

    foreach($arg in $CommandLineArguments){
        try{
            $events = $events | ?{$_.Properties[9].Value.Contains($arg)}
        }catch{
        }
        Write-Verbose "$arg $events.Count"
    }

    return $events 
}


#Atbroker.exe
Get-SysmonCQDetails "C:\Windows\System32\Atbroker.exe" "/start"
Get-SysmonCQDetails "C:\Windows\SysWOW64\Atbroker.exe" "/start"


#Bash.exe
Get-SysmonCQDetails "c:\windows\system32\bash.exe"


#BitsAdmin.exe

Get-SysmonCQDetails "c:\windows\system32\bitsadmin.exe" "/addfile"
Get-SysmonCQDetails "c:\windows\sysWOW64\bitsadmin.exe" "/addfile"

#certutil
Get-SysmonCQDetails "c:\windows\system32\certutil.exe" "urlcache","split","f"
Get-SysmonCQDetails "c:\windows\sysWOW64\certutil.exe" "urlcache","split","f"

#cmdKey

Get-SysmonCQDetails "c:\windows\system32\cmdkey.exe" "list"
Get-SysmonCQDetails "c:\windows\sysWOW64\cmdkey.exe" "list"

#cmstp
 
Get-SysmonCQDetails "c:\windows\system32\cmstp.exe" "/ni /s"
Get-SysmonCQDetails "c:\windows\sysWOW64\cmstp.exe" "/ni /s"

#control

Get-SysmonCQDetails "c:\windows\system32\control.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\control.exe" 

#csc
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\Csc.exe" "out"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe" "out"

Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\Csc.exe" "target"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe" "target"

#cscript

Get-SysmonCQDetails "c:\windows\system32\cscript.exe"
Get-SysmonCQDetails "c:\windows\sysWOW64\cscript.exe"

#Dfsvc

Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v2.0.50727\Dfsvc.exe"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v2.0.50727\Dfsvc.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\Dfsvc.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Dfsvc.exe"  

#Diskshadow

Get-SysmonCQDetails "c:\windows\system32\diskshadow.exe" "/s"
Get-SysmonCQDetails "c:\windows\sysWOW64\diskshadow.exe" "/s"

#Dnscmd

Get-SysmonCQDetails "c:\windows\system32\Dnscmd.exe" "serverlevelplugindll "
Get-SysmonCQDetails "c:\windows\sysWOW64\Dnscmd.exe" "serverlevelplugindll "

#esentutl

Get-SysmonCQDetails "c:\windows\system32\esentutl.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\esentutl.exe" 

#Expand

Get-SysmonCQDetails "c:\windows\system32\Expand.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Expand.exe" 

#Extexport
Get-SysmonCQDetails "C:\Program Files\Internet Explorer\Extexport.exe"    
Get-SysmonCQDetails "C:\Program Files\Internet Explorer(x86)\Extexport.exe"

#extrac32

Get-SysmonCQDetails "c:\windows\system32\extrac32.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\extrac32.exe" 

#forfiles

Get-SysmonCQDetails "c:\windows\system32\forfiles.exe" "/c","/m","/p"
Get-SysmonCQDetails "c:\windows\sysWOW64\forfiles.exe" "/c","/m","/p" 


#gpscript

Get-SysmonCQDetails "c:\windows\system32\gpscript.exe" "logon"
Get-SysmonCQDetails "c:\windows\sysWOW64\gpscript.exe" "logon"

Get-SysmonCQDetails "c:\windows\system32\gpscript.exe" "startup"
Get-SysmonCQDetails "c:\windows\sysWOW64\gpscript.exe" "startup"


#hh

Get-SysmonCQDetails "c:\windows\system32\hh.exe" "ps1"
Get-SysmonCQDetails "c:\windows\sysWOW64\hh.exe" "ps1"


Get-SysmonCQDetails "c:\windows\system32\hh.exe" "http"
Get-SysmonCQDetails "c:\windows\sysWOW64\hh.exe" "http"

#ie4uinit

Get-SysmonCQDetails "c:\windows\system32\ie4uinit.exe" "BaseSettings"
Get-SysmonCQDetails "c:\windows\sysWOW64\ie4uinit.exe" "BaseSettings"

#ieexec

Get-SysmonCQDetails "c:\windows\system32\ieexec.exe" "http"
Get-SysmonCQDetails "c:\windows\sysWOW64\ieexec.exe" "http"


#InfDefaultInstall

Get-SysmonCQDetails "c:\windows\system32\InfDefaultInstall.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\InfDefaultInstall.exe" 

#InstallUtil

Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v2.0.50727\InstallUtil.exe"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v2.0.50727\InstallUtil.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe"  


#makecab

Get-SysmonCQDetails "c:\windows\system32\makecab.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\makecab.exe" 


#Mavinject

Get-SysmonCQDetails "c:\windows\system32\Mavinject.exe" "INJECTRUNNING"
Get-SysmonCQDetails "c:\windows\sysWOW64\Mavinject.exe" "INJECTRUNNING"


#msbuild

Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v2.0.50727\msbuild.exe"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v2.0.50727\msbuild.exe"  
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v3.5\msbuild.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v3.5\msbuild.exe"   
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\msbuild.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe"  


#Msconfig

Get-SysmonCQDetails "c:\windows\system32\Msconfig.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Msconfig.exe" 

#msdt

Get-SysmonCQDetails "c:\windows\system32\msdt.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\msdt.exe" 

#mshta

Get-SysmonCQDetails "c:\windows\system32\mshta.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\mshta.exe" 

#Msiexec

Get-SysmonCQDetails "c:\windows\system32\Msiexec.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Msiexec.exe" 

#netsh

Get-SysmonCQDetails "c:\windows\system32\netsh.exe" "start"
Get-SysmonCQDetails "c:\windows\sysWOW64\netsh.exe" "start"

#Nltest

Get-SysmonCQDetails "c:\windows\system32\Nltest.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Nltest.exe" 

#odbcconf

Get-SysmonCQDetails "c:\windows\system32\odbcconf.exe" "-f" 
Get-SysmonCQDetails "c:\windows\sysWOW64\odbcconf.exe" "-f"

#Openwith

Get-SysmonCQDetails "c:\windows\system32\Openwith.exe" "/c" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Openwith.exe" "/c"

#Pcalua

Get-SysmonCQDetails "c:\windows\system32\Pcalua.exe" "-a"
Get-SysmonCQDetails "c:\windows\sysWOW64\Pcalua.exe" "-a"

#Pcwrun

Get-SysmonCQDetails "c:\windows\system32\Pcwrun.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Pcwrun.exe" 

#Powershell

Get-SysmonCQDetails "C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe" "-ec"
Get-SysmonCQDetails "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" "-ec"
Get-SysmonCQDetails "C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe" "-encodedCommand"
Get-SysmonCQDetails "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" "-encodedCommand"


#Presentationhost

Get-SysmonCQDetails "c:\windows\system32\PresentationHost.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\PresentationHost.exe" 

#print

Get-SysmonCQDetails "c:\windows\system32\print.exe" "/D:"
Get-SysmonCQDetails "c:\windows\sysWOW64\print.exe" "/D:"

#Psr

Get-SysmonCQDetails "c:\windows\system32\Psr.exe" "start"
Get-SysmonCQDetails "c:\windows\sysWOW64\Psr.exe" "start"

#regasm

Get-SysmonCQDetails "c:\windows\system32\regasm.exe" "/U"
Get-SysmonCQDetails "c:\windows\sysWOW64\regasm.exe" "/U"

#Register-cimprovider

Get-SysmonCQDetails "c:\windows\system32\Register-cimprovider.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Register-cimprovider.exe"

#Regsvcs

Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v2.0.50727\regsvcs.exe"
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v2.0.50727\regsvcs.exe"  
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v3.5\regsvcs.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v3.5\regsvcs.exe"   
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework\v4.0.30319\regsvcs.exe"    
Get-SysmonCQDetails "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\regsvcs.exe"  

#Regsvr32

Get-SysmonCQDetails "c:\windows\system32\Regsvr32.exe" "/s","/u","/i"
Get-SysmonCQDetails "c:\windows\sysWOW64\Regsvr32.exe" "/s","/u","/i"


#Rpcping

Get-SysmonCQDetails "c:\windows\system32\Rpcping.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\Rpcping.exe"

#Rundll32

Get-SysmonCQDetails "c:\windows\system32\Rundll32.exe" "javascript"
Get-SysmonCQDetails "c:\windows\sysWOW64\Rundll32.exe" "javascript"

#SC

Get-SysmonCQDetails "c:\windows\system32\sc.exe" "create"
Get-SysmonCQDetails "c:\windows\sysWOW64\cs.exe" "create"

#Scriptrunner

Get-SysmonCQDetails "c:\windows\system32\Scriptrunner.exe" "appvscript"
Get-SysmonCQDetails "c:\windows\sysWOW64\Scriptrunner.exe" "appvscript"


#SyncAppvPublishingServer

Get-SysmonCQDetails "c:\windows\system32\SyncAppvPublishingServer.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\SyncAppvPublishingServer.exe" 


#wmic

Get-SysmonCQDetails "c:\windows\system32\wmic.exe" "process call create"
Get-SysmonCQDetails "c:\windows\sysWOW64\wmic.exe" "process call create"

Get-SysmonCQDetails "c:\windows\system32\wmic.exe" "process get brief /format"
Get-SysmonCQDetails "c:\windows\sysWOW64\wmic.exe" "process get brief /format"

#wscript

Get-SysmonCQDetails "c:\windows\system32\wscript.exe" 
Get-SysmonCQDetails "c:\windows\sysWOW64\wscript.exe" 

#xwizard

Get-SysmonCQDetails "c:\windows\system32\xwizard.exe" "RunWizard"
Get-SysmonCQDetails "c:\windows\sysWOW64\xwizard.exe" "RunWizard"

